<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scan to Pay</title>
<style>
  :root{ --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --border:#334155; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#0b1220,#111827); color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:1rem;}
  .wrap{width:100%; max-width:720px; background:rgba(15,23,42,.9); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.35); overflow:hidden;}
  header{padding:1rem 1.2rem; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between;}
  .brand{display:flex; align-items:center; gap:.6rem; font-weight:800;}
  .brand img{height:36px; width:auto; border-radius:8px;}
  main{padding:1.2rem; display:grid; grid-template-columns: 1fr 1fr; gap:1.2rem;}
  @media(max-width:720px){ main{ grid-template-columns: 1fr; } }
  .qr{background:#0b1220; border:1px solid var(--border); border-radius:12px; display:flex; align-items:center; justify-content:center; padding:1rem; min-height:300px; text-align:center;}
  .qr img{max-width:100%; height:auto; display:block;}
  .meta{display:flex; flex-direction:column; gap:.7rem;}
  label{font-size:.9rem; color:var(--muted);}
  input[type="text"], input[type="email"]{width:100%; padding:.6rem .7rem; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:#e5e7eb;}
  .total{font-weight:900; font-size:1.3rem;}
  .method{font-weight:700; color:#93c5fd;}
  .row{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center;}
  .btn{cursor:pointer; border:0; border-radius:10px; padding:.7rem 1rem; font-weight:800; }
  .primary{background:var(--accent); color:#052e16;}
  .ghost{background:#0b1220; color:#fff; border:1px solid var(--border);}
  .ok{color:#86efac; font-weight:700; display:none;}

  /* Thank-you overlay */
  .overlay{
    position:fixed; inset:0; z-index:9999; display:none;
    align-items:center; justify-content:center; text-align:center;
    background:#000; color:#fff;
  }
  .overlay.visible{ display:flex; }
  .overlay::before{
    content:"";
    position:absolute; inset:0; opacity:.25; background:#000;
  }
  .overlay .bg{
    position:absolute; inset:0; background-position:center; background-size:cover; background-repeat:no-repeat;
    filter:contrast(1.08) saturate(1.08);
  }
  .overlay .content{
    position:relative; z-index:1; padding:2rem; max-width:90%;
  }
  .overlay h1{ font-size:clamp(28px, 6vw, 56px); margin:.2rem 0 .6rem; letter-spacing:.5px; }
  .overlay p{ font-size:clamp(14px, 2.8vw, 18px); opacity:.9; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img id="logoImg" alt="" style="display:none;">
        <div id="logoText">MERCH</div>
      </div>
      <div class="method" id="methodDisplay">Venmo</div>
    </header>
    <main>
      <div class="qr" id="qrBox">
        <div style="color:#64748b;">No QR configured.<br/>Add a QR image in Manage, or this is a cash payment.</div>
      </div>
      <div class="meta">
        <div class="total">Total: $<span id="amount">0.00</span></div>
        <div class="row">
          <label style="flex:1 1 220px;">Customer Name
            <input id="custName" placeholder="First Last" type="text" autocomplete="name">
          </label>
          <label style="flex:1 1 220px;">Customer Email
            <input id="custEmail" placeholder="name@email.com" type="email" autocomplete="email">
          </label>
        </div>

        <label class="row" style="gap:.5rem; align-items:flex-start;">
          <input id="optIn" type="checkbox" style="margin-top:.15rem;">
          <span style="font-size:.9rem; color:#cbd5e1;">
            This records payment method and customer details to a log file for our records. We may contact you in the future about future merch and shows.
          </span>
        </label>

        <div class="row" style="margin-top:.2rem;">
          <button id="markPaid" class="btn primary">Mark Paid & Save</button>
          <button id="closeBtn" class="btn ghost">Done / Close</button>
        </div>
        <div id="okMsg" class="ok">Saved! You can close this tab.</div>
      </div>
    </main>
  </div>

  <!-- Thank You Overlay -->
  <div id="tyOverlay" class="overlay" role="dialog" aria-live="polite" aria-label="Thank you">
    <div id="gifBg" class="bg"></div>
    <div class="content">
      <h1>Thank you for your support!</h1>
      <p>You rock ðŸ¤˜</p>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SETTINGS_KEY = 'mp_settings_v1';
  const RUNTIME_KEY  = 'mp_runtime_v1';

  const $ = id => document.getElementById(id);
  const safe = (fn) => { try{ fn(); }catch(e){ console.error(e); } };

  function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }catch(e){ return {}; } }
  function loadRuntime(){ try{ return JSON.parse(localStorage.getItem(RUNTIME_KEY)) || {salesLog:[]}; }catch(e){ return {salesLog:[]}; } }
  function saveRuntime(rt){ localStorage.setItem(RUNTIME_KEY, JSON.stringify(rt)); }

  const params = new URLSearchParams(location.search);
  const method = (params.get('method')||'').toLowerCase(); // venmo | paypal | cash
  const amount = params.get('amount') || '0.00';
  const batch  = params.get('batch')  || '';
  const testOverlay = params.get('testOverlay') === '1';

  // Header branding
  safe(()=>{
    const s = loadSettings();
    if (s.headerLogoImage) { $('logoImg').src = s.headerLogoImage; $('logoImg').style.display='block'; $('logoText').style.display='none'; }
    else { $('logoText').textContent = s.headerLogoText || 'MERCH'; }
  });

  // Method & amount
  safe(()=>{
    const methodTitle = method==='paypal' ? 'PayPal' : method==='cash' ? 'Cash' : 'Venmo';
    $('methodDisplay').textContent = methodTitle;
    $('amount').textContent = amount;
  });

  // QR (or Cash placeholder)
  safe(()=>{
    const s = loadSettings();
    const box = $('qrBox');
    if(method === 'cash'){
      box.innerHTML = '<div><div style="font-weight:800; font-size:1.15rem; margin-bottom:.25rem;">Cash Payment</div><div style="color:#94a3b8">Enter name & email, then mark paid.</div></div>';
    } else {
      const src = method==='paypal' ? (s.paypalQR || '') : (s.venmoQR || '');
      if(src){
        box.innerHTML = '';
        const img = document.createElement('img'); img.src = src; img.alt = (method==='paypal'?'PayPal':'Venmo') + ' QR';
        box.appendChild(img);
      }
    }
  });

  // Thank-you overlay helpers
  const FALLBACK_GIFS = [
    "https://media.giphy.com/media/l0HlOvJ7yaacpuSas/giphy.gif",
    "https://media.giphy.com/media/3o6Zt6ML6BklcajjsA/giphy.gif",
    "https://media.giphy.com/media/3o6gE5aYQdQHBlC9zC/giphy.gif",
    "https://media.giphy.com/media/3oEduSbSGpGaRX2Vri/giphy.gif"
  ];
  function showThankYou(){
    const overlay = $('tyOverlay');
    const bg = $('gifBg');
    // show immediately
    overlay.classList.add('visible');
    // set a GIF non-blocking
    const pick = FALLBACK_GIFS[Math.floor(Math.random()*FALLBACK_GIFS.length)];
    if(pick){ bg.style.backgroundImage = `url('${pick}')`; }
  }

  // Save / Mark paid
  safe(()=>{
    $('markPaid').addEventListener('click', ()=>{
      const name  = ($('custName').value || '').trim();
      const email = ($('custEmail').value || '').trim();
      const optIn = $('optIn').checked ? true : false;

      const rt = loadRuntime();
      rt.salesLog = (rt.salesLog||[]).map(s=>{
        if(s.batchId === batch){
          return {...s,
            payment: method || s.payment || '',
            customerName: name,
            customerEmail: email,
            marketingOptIn: optIn,
            paidAt: new Date().toISOString()
          };
        }
        return s;
      });
      saveRuntime(rt);

      $('okMsg').style.display = 'block';
      showThankYou();
    });
  });

  // Close button
  safe(()=> $('closeBtn').addEventListener('click', ()=> window.close()) );

  // Debug/test: force overlay via URL flag
  if (testOverlay) { showThankYou(); }
});
</script>
</body>
</html>
