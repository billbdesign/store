<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scan to Pay</title>
<style>
  :root{ --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --border:#334155; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#0b1220,#111827); color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:1rem;}
  .wrap{width:100%; max-width:720px; background:rgba(15,23,42,.9); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.35); overflow:hidden;}
  header{padding:1rem 1.2rem; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between;}
  .brand{display:flex; align-items:center; gap:.6rem; font-weight:800;}
  .brand img{height:36px; width:auto; border-radius:8px;}
  main{padding:1.2rem; display:grid; grid-template-columns: 1fr 1fr; gap:1.2rem;}
  @media(max-width:720px){ main{ grid-template-columns: 1fr; } }
  .qr{background:#0b1220; border:1px solid var(--border); border-radius:12px; display:flex; align-items:center; justify-content:center; padding:1rem; min-height:300px;}
  .qr img{max-width:100%; height:auto; display:block;}
  .meta{display:flex; flex-direction:column; gap:.7rem;}
  label{font-size:.9rem; color:var(--muted);}
  input{width:100%; padding:.6rem .7rem; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:var(--text);}
  .total{font-weight:900; font-size:1.3rem;}
  .method{font-weight:700; color:#93c5fd;}
  .row{display:flex; gap:.6rem; flex-wrap:wrap;}
  .btn{cursor:pointer; border:0; border-radius:10px; padding:.7rem 1rem; font-weight:800; }
  .primary{background:var(--accent); color:#052e16;}
  .ghost{background:#0b1220; color:var(--text); border:1px solid var(--border);}
  .ok{color:#86efac; font-weight:700; display:none;}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img id="logoImg" alt="" style="display:none;">
        <div id="logoText">MERCH</div>
      </div>
      <div class="method" id="methodDisplay">Venmo</div>
    </header>
    <main>
      <div class="qr" id="qrBox">
        <div style="text-align:center; color:#64748b;">No QR configured.<br/>Add a QR image in Manage.</div>
      </div>
      <div class="meta">
        <div class="total">Total: $<span id="amount">0.00</span></div>
        <div class="row">
          <label style="flex:1 1 220px;">Customer Name
            <input id="custName" placeholder="First Last">
          </label>
          <label style="flex:1 1 220px;">Customer Email
            <input id="custEmail" placeholder="name@email.com">
          </label>
        </div>
        <div class="row">
          <button id="markPaid" class="btn primary">Mark Paid & Save</button>
          <button class="btn ghost" onclick="window.close()">Done / Close</button>
        </div>
        <div id="okMsg" class="ok">Saved! You can close this tab.</div>
        <div style="color:#94a3b8; font-size:.85rem;">This records payment method and customer details to your CSV log for just this checkout.</div>
      </div>
    </main>
  </div>

<script>
  const SETTINGS_KEY = 'mp_settings_v1';
  const RUNTIME_KEY  = 'mp_runtime_v1';

  function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }catch(e){ return {}; } }
  function loadRuntime(){ try{ return JSON.parse(localStorage.getItem(RUNTIME_KEY)) || {salesLog:[]}; }catch(e){ return {salesLog:[]}; } }
  function saveRuntime(rt){ localStorage.setItem(RUNTIME_KEY, JSON.stringify(rt)); }

  function qs(key){
    const p = new URLSearchParams(location.search);
    return p.get(key);
  }

  const method = (qs('method')||'').toLowerCase();
  const amount = qs('amount') || '0.00';
  const batch  = qs('batch')  || '';
  const methodTitle = method==='paypal' ? 'PayPal' : 'Venmo';
  document.getElementById('methodDisplay').textContent = methodTitle;
  document.getElementById('amount').textContent = amount;

  // Header branding
  (function(){
    const s = loadSettings();
    const li = document.getElementById('logoImg');
    const lt = document.getElementById('logoText');
    if(s.headerLogoImage){ li.src = s.headerLogoImage; li.style.display='block'; lt.style.display='none'; }
    else { lt.textContent = s.headerLogoText || 'MERCH'; li.style.display='none'; }
  })();

  // QR image
  (function(){
    const s = loadSettings();
    const src = method==='paypal' ? (s.paypalQR || '') : (s.venmoQR || '');
    const box = document.getElementById('qrBox');
    if(src){
      box.innerHTML = '';
      const img = document.createElement('img'); img.src = src; img.alt = methodTitle + ' QR';
      box.appendChild(img);
    }
  })();

  // Mark paid
  document.getElementById('markPaid').addEventListener('click', ()=>{
    const name  = document.getElementById('custName').value.trim();
    const email = document.getElementById('custEmail').value.trim();

    const rt = loadRuntime();
    // Update ONLY the lines that have this checkout's batch id
    rt.salesLog = (rt.salesLog||[]).map(s=>{
      if(s.batchId === batch){
        return {...s, payment: method, customerName:name, customerEmail:email, paidAt: new Date().toISOString()};
      }
      return s;
    });
    saveRuntime(rt);

    const ok = document.getElementById('okMsg');
    ok.style.display = 'block';
  });
</script>
</body>
</html>
